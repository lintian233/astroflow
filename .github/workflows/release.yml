name: release

on:
  push:
    tags: ['v*'] 
    # branches: ['enhded']         
  workflow_dispatch:      

jobs:
  build-linux:
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v4

      # 如果你的 Docker Hub 镜像是【私有】，解注释并配置仓库 Secrets:
      #   DOCKERHUB_USERNAME / DOCKERHUB_TOKEN
      # - uses: docker/login-action@v3
      #   with:
      #     registry: docker.io
      #     username: ${{ secrets.DOCKERHUB_USERNAME }}
      #     password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 缓存宿主的 conan2 目录，后面会通过 CIBW_MOUNT 挂进容器，显著加速
      - name: Cache Conan2
        uses: actions/cache@v4
        with:
          path: ~/.conan2
          key: conan2-linux-${{ hashFiles('conanfile.txt') }}
          restore-keys: |
            conan2-linux-

      - name: Install cibuildwheel
        run: |
          python -m pip install -U pip
          pip install "cibuildwheel==2.*"

      - name: Build wheels in your manylinux+CUDA image
        env:
          # ✅ 需要支持的 Python 版本（全覆盖 cp38..cp312）
          CIBW_BUILD: "cp38-* cp39-* cp310-* cp311-* cp312-*"
          # 我们的基础镜像是 manylinux，不构建 musllinux
          CIBW_SKIP: "cp*-musllinux*"
          CIBW_ARCHS: "x86_64"

          CIBW_MANYLINUX_X86_64_IMAGE: "docker.io/lintian233/astroflow-build:cuda12.9-manylinux_2_28-x86_64"

          # 在每个 Python 目标环境启动前执行一次（容器内）
          # 你的镜像里已用 cp312 预装 conan，这里幂等初始化 profile，保证存在即可
          CIBW_BEFORE_ALL: >
            /opt/python/cp312-cp312/bin/conan --version &&
            /opt/python/cp312-cp312/bin/conan profile detect --force

          # 把宿主的 ~/.conan2 挂载到容器的 /root/.conan2，命中上面的缓存
          CIBW_MOUNT: "$HOME/.conan2:/root/.conan2"

          # 日志等级：0..3
          CIBW_BUILD_VERBOSITY: "1"

        run: cibuildwheel --output-dir wheelhouse
    
      - name: Upload dist
        uses: actions/upload-artifact@v4
        with:
          name: dists
          path: wheelhouse/*


  publish-testpypi:
    needs: build-linux
    runs-on: ubuntu-22.04
    environment:
      name: testpypi
      url: https://test.pypi.org/p/pulseflow
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/download-artifact@v4
        with: { name: dists, path: dist }
      - name: Upload to TestPyPI (OIDC)
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/
          packages-dir: dist
          skip-existing: true
      # 如果用 API Token，改成：
      # - uses: pypa/gh-action-pypi-publish@release/v1
      #   with:
      #     repository-url: https://test.pypi.org/legacy/
      #     user: __token__
      #     password: ${{ secrets.TEST_PYPI_API_TOKEN }}
      #     packages-dir: dist
      #     skip-existing: true


  publish-pypi:
    needs: [build-linux, publish-testpypi]
    runs-on: ubuntu-22.04
    environment:
      name: pypi
      url: https://pypi.org/p/pulseflow
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/download-artifact@v4
        with: { name: dists, path: dist }
      - name: Upload to PyPI (OIDC)
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist
          skip-existing: false